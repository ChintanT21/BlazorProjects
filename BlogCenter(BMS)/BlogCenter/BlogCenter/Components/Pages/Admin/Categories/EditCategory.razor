@page "/admin/categories/edit"
@rendermode InteractiveServer
@using BlogCenter.Services.Category
@using BlogCenter.WebAPI.Dtos.Constant
@using BlogCenter.WebAPI.Dtos.RequestDto
@using BlogCenter.WebAPI.Dtos.Mapper
@using static BlogCenter.WebAPI.Dtos.ResponceDto.CategoryDto
@inject ISnackbar Snackbar
@inject ICategoryClientService _clientService
@inject NavigationManager _navigationManager

<div class=" container">
    <div class="d-flex justify-content-between align-items-center my-4">
        <MudText Typo="Typo.h5" Class="fw-bold">Edit Category</MudText>
        <MudButton Class="mx-1" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.ArrowBack" Color="Color.Primary" OnClick=NavigateToCategoryList>Back</MudButton>
    </div>
    <EditForm Model="@updateCategoryDto" OnValidSubmit="UpdateCategory">
        <DataAnnotationsValidator />
        <MudGrid>
            <MudItem xs="12" sm="7">
                <MudCard>
                    <MudCardContent>
                        <MudTextField Label="Category name" HelperText="Max. 50 characters"
                                      @bind-Value="updateCategoryDto.Name" For="@(() => updateCategoryDto.Name)" />
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">Add</MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        </MudGrid>
    </EditForm>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "categoryId")]
    public int? categoryId { get; set; }

    protected UpdateCategoryDto updateCategoryDto = new();
    protected GetCategoryDto categoryDto = new();
    protected async override Task OnInitializedAsync()
    {
        categoryDto = await _clientService.GetCategoryById((int)categoryId);
        updateCategoryDto = categoryDto.ToUpdateCategoryDto();
    }
    public async Task UpdateCategory()
    {
        Dictionary<bool, string> isAdded = await _clientService.UpdateCategory(updateCategoryDto);

        if (isAdded.FirstOrDefault().Key)
        {
            Snackbar.Add(isAdded.FirstOrDefault().Value, Severity.Success, c => c.SnackbarVariant = Variant.Filled);
            _navigationManager.NavigateTo(Constants.NAVIGATE_TO_CATEGORYLIST_URL);
        }
        else if (isAdded.FirstOrDefault().Value == Constants.CATEGORY_EXISTS_ERROR)
        {
            Snackbar.Add(isAdded.FirstOrDefault().Value, Severity.Error, c => c.SnackbarVariant = Variant.Filled);
        }
        else
        {
            Snackbar.Add(isAdded.FirstOrDefault().Value, Severity.Error, c => c.SnackbarVariant = Variant.Filled);
        }
    }

    public void NavigateToCategoryList()
    {
        _navigationManager.NavigateTo(Constants.NAVIGATE_TO_CATEGORYLIST_URL);
    }
}
