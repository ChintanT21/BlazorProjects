@page "/edit-blog"
@rendermode InteractiveServer
@inject AuthenticationStateProvider _authenticationStateProvider
@inject NavigationManager _navigationManager
@inject IJSRuntime _jsRuntime
@using BlogCenter.Blazor.Services
@using BlogCenter.WebAPI.Dtos.RequestDto
@using BlogCenter.WebAPI.Dtos.ResponceDto
@using BlogCenter.WebAPI.Dtos
@using BlogCenter.WebAPI.Dtos.Mapper

<div class="container">
    <div class="row mt-2 d-flex justify-content-around">
        <div class="col ">
            <h4>Edit Blog</h4>
        </div>
        <div class="col ">
            <button class="btn btn-info" @onclick=NavigateToAdminDashboard>
                <i class="fa-solid fa-chevron-left"></i>
                Back
            </button>
        </div>
    </div>
    <EditForm FormName="AddBlogForm" Model="@blog" class="form-floating" OnValidSubmit="EditThisBlog">
        <DataAnnotationsValidator />
        <div class="row">
            <div class="col-sm-12 col-md-4 col-xl-4 col-xxl-6 col mt-2">
                <label class=" fw-bolder" for="Title">Title:</label>
            </div>
            <div class="col-sm-12 col-ms-8 col-xl-8 col-xxl-6 col mt-2">
                <InputText id="Title" @bind-Value="blog.Title" class="form-control" />
                <ValidationMessage For="@(()=>blog.Title)" />
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12 col-md-4 col-xl-4 col-xxl-6 col mt-2">
                <label class=" fw-bolder" for="Title">Content:</label>
            </div>
            <div class="col-sm-12 col-ms-8 col-xl-8 col-xxl-6 col mt-2">
                <input @bind=blog.Content class="form-control">Welcome</input>
                <ValidationMessage For="@(()=>blog.Content)" />
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12 col-md-4 col-xl-4 col-xxl-6 col mt-2">
                <label class=" fw-bolder" for="Title">Category:</label>
            </div>
            <div class="col-sm-12 col-ms-8 col-xl-8 col-xxl-6 col mt-2">
                <div>
                    <select multiple @onchange="OnSelectionChanged" class="form-control">
                        @foreach (var category in categories)
                        {
                            <option value="@category.Id" selected="@SelectedIds.Contains(category.Id)">@category.Name</option>
                        }
                    </select>
                </div>
                <div>
                    <p>Selected Items:</p>
                    <ul>
                        @foreach (var item in SelectedItems)
                        {
                            <li>@item.Name</li>
                        }
                    </ul>
                </div>
                <div class="multi-select">
                    <input type="text" class="form-control" @onclick="ToggleDropdown" @oninput="OnSearch" placeholder="Search and select..." />
                    @if (isOpen)
                    {
                        <ul>
                            @foreach (var item in filteredItems)
                            {
                                <li>
                                    <input type="checkbox" id="@item" @onchange="() => OnSelectionChanged(item)" checked="@selectedItems.Contains(item)" />
                                    <label for="@item">@item</label>
                                </li>
                            }
                        </ul>
                    }
                </div>  

                <ValidationMessage For="@(() => blog.Categories)" />
            </div>
        </div>
        <div class="mt-2 d-flex justify-content-end">
            <button class="btn btn-success" type="submit">
                @if (showLoding == true)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                }
                Submit
            </button>
        </div>
    </EditForm>

</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "blogid")]
    public string? blogid { get; set; }
    [Inject]protected IClientService? _clientService { get; set; }
    protected bool showLoding = false;
    protected BlogDto blog = new();
    protected GetBlogDto.GetBlog baseblog = new();
    protected List<GetCategoryDto> categories = new();
    public class SelectItem
    {
        public int Id { get; set; }
        public string Name { get; set; }
    }
    private List<int> SelectedIds { get; set; } = new List<int>();
    private List<GetCategoryDto> SelectedItems { get; set; } = new List<GetCategoryDto>();

    private void OnSelectionChanged(ChangeEventArgs e)
    {
        var selectedValues = ((IEnumerable<string>)e.Value).Select(int.Parse).ToList();
        SelectedIds = selectedValues;
        SelectedItems = categories.Where(c => SelectedIds.Contains(c.Id)).ToList();
        blog.Categories = selectedValues;
    }

    string ClaimTypeId = "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier";
    long userId;
    protected override async Task OnInitializedAsync()
    {
        if (long.TryParse(blogid, out var BlogId))
        {
            // Fetch the blog details from the server or service
            baseblog = await _clientService.GetOneBlog(BlogId);
            blog = baseblog.ToBlogDto();
            SelectedIds = baseblog.BlogsCategoriesIntList;
        }
        else
        {
            // Handle invalid blogId
            _navigationManager.NavigateTo("/blog-list");
        }
   
        var authState = await _authenticationStateProvider.GetAuthenticationStateAsync();
        var userClaims = authState.User.Claims;
        userId = Int64.Parse(userClaims.FirstOrDefault(c => c.Type == ClaimTypeId)?.Value);
        categories = await _clientService.GetAllCategories();
    }

    protected async void EditThisBlog()
    {
        bool isUpdated = await _clientService.UpdateBlog(blog);
        if (isUpdated)
        {
            NavigateToAdminDashboard();
        }
    }
    private void NavigateToAdminDashboard()
    {
        _navigationManager.NavigateTo("/admin-dashboard");
    }
    private List<string> items = new() { "Item 1", "Item 2", "Item 3", "Item 4", "Item 5" };
    private List<string> selectedItems = new();
    private List<string> filteredItems = new();
    private bool isOpen = false;

    protected override void OnInitialized()
    {
        filteredItems = items;
    }

    private void ToggleDropdown()
    {
        isOpen = !isOpen;
    }

    private void OnSearch(ChangeEventArgs e)
    {
        var searchValue = e.Value.ToString().ToLower();
        filteredItems = items.Where(item => item.ToLower().Contains(searchValue)).ToList();
    }

    private void OnSelectionChanged(string item)
    {
        if (selectedItems.Contains(item))
        {
            selectedItems.Remove(item);
        }
        else
        {
            selectedItems.Add(item);
        }
    }

}
